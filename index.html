<script>
(function () {
  const form = document.getElementById("delegation-form");
  const canvas = document.getElementById("signature-canvas");
  const ctx = canvas.getContext("2d");

  let drawing = false;
  let lastX = 0;
  let lastY = 0;
  let hasSignature = false;
  let savedSignature = null;

  const signatureError = document.getElementById("signature-error");
  const formError = document.getElementById("form-error");

  /* =========================
     캔버스 초기화 (지워지지 않게)
  ========================== */
  function setupCanvas() {
    const rect = canvas.getBoundingClientRect();
    const ratio = window.devicePixelRatio || 1;

    const prev = hasSignature ? canvas.toDataURL() : null;

    canvas.width = rect.width * ratio;
    canvas.height = 220 * ratio;
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;

    if (prev) restoreSignature(prev);
  }

  function restoreSignature(dataUrl) {
    const img = new Image();
    img.onload = () => {
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    };
    img.src = dataUrl;
  }

  setupCanvas();

  /* ❌ window.resize 사용 안함 (서명 지워지는 원인)
     ✅ ResizeObserver로 가로 변경만 감지 */
  const ro = new ResizeObserver(() => {
    requestAnimationFrame(setupCanvas);
  });
  ro.observe(canvas);

  /* =========================
     드로잉 로직
  ========================== */
  function start(x, y) {
    drawing = true;
    hasSignature = true;
    lastX = x;
    lastY = y;
    hideError(signatureError);
  }

  function draw(x, y) {
    if (!drawing) return;
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    lastX = x;
    lastY = y;
  }

  function stop() {
    drawing = false;
    if (hasSignature) {
      savedSignature = canvas.toDataURL();
    }
  }

  function pos(e) {
    const r = canvas.getBoundingClientRect();
    return { x: e.clientX - r.left, y: e.clientY - r.top };
  }

  /* 마우스 */
  canvas.addEventListener("mousedown", e => {
    const p = pos(e);
    start(p.x, p.y);
  });
  canvas.addEventListener("mousemove", e => {
    const p = pos(e);
    draw(p.x, p.y);
  });
  window.addEventListener("mouseup", stop);

  /* 터치 */
  canvas.addEventListener("touchstart", e => {
    e.preventDefault();
    const t = e.touches[0];
    const r = canvas.getBoundingClientRect();
    start(t.clientX - r.left, t.clientY - r.top);
  }, { passive:false });

  canvas.addEventListener("touchmove", e => {
    e.preventDefault();
    const t = e.touches[0];
    const r = canvas.getBoundingClientRect();
    draw(t.clientX - r.left, t.clientY - r.top);
  }, { passive:false });

  canvas.addEventListener("touchend", stop, { passive:false });

  /* =========================
     서명 지우기
  ========================== */
  document.getElementById("clear-signature").addEventListener("click", () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    hasSignature = false;
    savedSignature = null;
    hideError(signatureError);
  });

  /* =========================
     에러 헬퍼
  ========================== */
  function showError(el, msg) {
    if (!el) return;
    if (msg) el.textContent = msg;
    el.style.display = "block";
  }
  function hideError(el) {
    if (!el) return;
    el.style.display = "none";
  }

  function requiredFilled() {
    const fields = [
      'input[name="full_name"]',
      'input[name="dong"]',
      'input[name="ho"]',
      'input[name="birth"]',
      'input[name="phone"]',
      'input[name="email"]'
    ];
    return fields.every(sel => {
      const el = document.querySelector(sel);
      return el && el.value.trim() !== "";
    });
  }

  function exportSignature() {
    const out = document.createElement("canvas");
    out.width = 800;
    out.height = 220;

    const octx = out.getContext("2d");
    octx.fillStyle = "#fff";
    octx.fillRect(0,0,out.width,out.height);
    octx.drawImage(canvas, 0, 0, out.width, out.height);

    return out.toDataURL("image/jpeg", 0.8);
  }

  /* =========================
     제출 처리
  ========================== */
  form.addEventListener("submit", function(e){
    hideError(formError);
    hideError(signatureError);

    const name = document.querySelector('input[name="full_name"]').value || "";
    const dong = document.querySelector('input[name="dong"]').value || "";
    const ho   = document.querySelector('input[name="ho"]').value || "";

    document.getElementById("email-subject").value =
      `힐스테이트 메디알레 전자 위임장 제출 - ${name} (${dong}동 ${ho}호)`;

    if (!requiredFilled()) {
      e.preventDefault();
      showError(formError, "필수항목을 입력해 주세요.");
      return;
    }

    if (!document.getElementById("consent-privacy").checked ||
        !document.getElementById("consent-delegation").checked) {
      e.preventDefault();
      showError(formError, "모든 동의사항에 체크해 주세요.");
      return;
    }

    if (!hasSignature) {
      e.preventDefault();
      showError(signatureError, "서명을 남겨주세요.");
      return;
    }

    document.getElementById("signature-image").value = exportSignature();
  });
})();
</script>
