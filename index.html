<script>
document.addEventListener("DOMContentLoaded", () => {
  // 에러가 나도 흰 화면이 아니라, 원인을 보여주기
  const showFatal = (msg) => {
    const box = document.createElement("div");
    box.style.position = "fixed";
    box.style.left = "10px";
    box.style.right = "10px";
    box.style.top = "10px";
    box.style.zIndex = "999999";
    box.style.padding = "12px 14px";
    box.style.borderRadius = "10px";
    box.style.background = "#fff";
    box.style.border = "2px solid #b4353d";
    box.style.color = "#3a1318";
    box.style.fontSize = "13px";
    box.style.lineHeight = "1.4";
    box.textContent = msg;
    document.body.appendChild(box);
  };

  window.addEventListener("error", (e) => {
    showFatal("스크립트 오류: " + (e.message || "알 수 없음"));
  });

  try {
    const form = document.getElementById("delegation-form");
    const canvas = document.getElementById("signature-canvas");
    const ctx = canvas ? canvas.getContext("2d") : null;

    if (!form || !canvas || !ctx) {
      // id가 바뀌었거나 캔버스가 없을 때도 페이지는 정상 표시되게
      showFatal("요소를 찾지 못했습니다. id 확인 필요: delegation-form / signature-canvas");
      return;
    }

    let isDrawing = false;
    let lastX = 0, lastY = 0;
    let hasSignature = false;

    const signatureInput = document.getElementById("signature-image");
    const signatureError = document.getElementById("signature-error");
    const formError = document.getElementById("form-error");

    const hide = (el) => { if (el) el.style.display = "none"; };
    const show = (el, msg) => { if (!el) return; if (msg) el.textContent = msg; el.style.display = "block"; };

    // 캔버스 리사이즈(모바일에서 체크박스 클릭 시 화면 튐 방지: resize 이벤트 과다 사용 X)
    const setupCanvas = () => {
      const rect = canvas.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;

      // 기존 그림 보존
      const prev = hasSignature ? canvas.toDataURL() : null;

      canvas.width = Math.max(1, Math.floor(rect.width * ratio));
      canvas.height = Math.floor(220 * ratio);
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

      ctx.strokeStyle = "#000";
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";

      if (prev) {
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0, rect.width, 220);
        img.src = prev;
      }
    };

    setupCanvas();

    // ResizeObserver가 있으면 사용, 없으면 resize 사용
    if ("ResizeObserver" in window) {
      const ro = new ResizeObserver(() => requestAnimationFrame(setupCanvas));
      ro.observe(canvas);
    } else {
      window.addEventListener("resize", setupCanvas);
    }

    const getPos = (clientX, clientY) => {
      const r = canvas.getBoundingClientRect();
      return { x: clientX - r.left, y: clientY - r.top };
    };

    const start = (x, y) => {
      isDrawing = true;
      hasSignature = true;
      lastX = x; lastY = y;
      hide(signatureError);
    };

    const draw = (x, y) => {
      if (!isDrawing) return;
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();
      lastX = x; lastY = y;
    };

    const stop = () => { isDrawing = false; };

    // Mouse
    canvas.addEventListener("mousedown", (e) => {
      const p = getPos(e.clientX, e.clientY);
      start(p.x, p.y);
    });
    canvas.addEventListener("mousemove", (e) => {
      const p = getPos(e.clientX, e.clientY);
      draw(p.x, p.y);
    });
    window.addEventListener("mouseup", stop);

    // Touch
    canvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      const t = e.touches[0];
      const p = getPos(t.clientX, t.clientY);
      start(p.x, p.y);
    }, { passive:false });

    canvas.addEventListener("touchmove", (e) => {
      e.preventDefault();
      const t = e.touches[0];
      const p = getPos(t.clientX, t.clientY);
      draw(p.x, p.y);
    }, { passive:false });

    canvas.addEventListener("touchend", stop, { passive:false });

    // Clear
    const clearBtn = document.getElementById("clear-signature");
    if (clearBtn) {
      clearBtn.addEventListener("click", () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        hasSignature = false;
        hide(signatureError);
      });
    }

    const requiredFilled = () => {
      const fields = [
        'input[name="full_name"]',
        'input[name="dong"]',
        'input[name="ho"]',
        'input[name="birth"]',
        'input[name="phone"]',
        'input[name="email"]'
      ];
      return fields.every(sel => {
        const el = document.querySelector(sel);
        return el && el.value.trim() !== "";
      });
    };

    const exportSignature = () => canvas.toDataURL("image/png");

    form.addEventListener("submit", (e) => {
      hide(formError);
      hide(signatureError);

      // 제목 세팅
      const name = document.querySelector('input[name="full_name"]')?.value || "";
      const dong = document.querySelector('input[name="dong"]')?.value || "";
      const ho   = document.querySelector('input[name="ho"]')?.value || "";
      const subject = document.getElementById("email-subject");
      if (subject) subject.value = `힐스테이트 메디알레 전자 위임장 제출 - ${name} (${dong}동 ${ho}호)`;

      // 필수 먼저
      if (!requiredFilled()) {
        e.preventDefault();
        show(formError, "필수항목을 입력해 주세요.");
        return;
      }

      // 동의
      const c1 = document.getElementById("consent-privacy")?.checked;
      const c2 = document.getElementById("consent-delegation")?.checked;
      if (!c1 || !c2) {
        e.preventDefault();
        show(formError, "모든 동의사항에 체크해 주세요.");
        return;
      }

      // 서명
      if (!hasSignature) {
        e.preventDefault();
        show(signatureError, "서명을 남겨주세요.");
        return;
      }

      if (signatureInput) signatureInput.value = exportSignature();
    });

  } catch (err) {
    showFatal("초기화 실패: " + (err?.message || err));
  }
});
</script>
